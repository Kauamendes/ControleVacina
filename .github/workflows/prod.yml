name: ControleVacinaDeployAws

on:
    push:
          branches: [Deploy]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Setup java
            uses: actions/setup-java@v3
            with:
              distribution: 'temurin'
              java-version: '17'
          - name: Build project
            run: mvn clean install -DskipTests
          - name: Login DockerHub
            run: docker login -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}
          - name: BUild Docker Image
            run: docker build -t kauamendes80/deploy-controle-vacina .
          - name: Push Image Docker
            run: docker push kauamendes80/deploy-controle-vacina

    deploy:
          needs: build
          runs-on: self-hosted
          steps:
            - name: Pull image from docker hub
              run: sudo docker pull kauamendes80/deploy-controle-vacina
            - name: Run docker container
              run: sudo docker run -d -p 8080:8080 -e DATABASE_PASSWORD=${{DB_PASS}} -e DATABASE_URL=${{DB_URL}} --name deploy-cadvacinas:latest